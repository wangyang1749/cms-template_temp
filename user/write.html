<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css"
        crossorigin="anonymous">
    <link rel="stylesheet" href="/templates/resources/themes/github.css">

    <link rel="stylesheet" href="/templates/resources/css/index.css?v=1.01">

    <link rel="stylesheet" type="text/css" href="/templates/resources/css/bootstrap-tags.css" />
    <link rel="stylesheet" href="/templates/resources/css/user.css">


    <title th:text="${view==null? '发布文章':view.title}"></title>
    <style>
        .write-option {
            position: fixed;
            top: 0rem;
            right: 14rem;
            padding: 1rem;
            background-color: rgba(206, 206, 206, 0.5);
            z-index: 9999;
        }

        .article-panel {
            border-radius: 0.5rem;
        }

        .article-input,
        .article-panel {
            border: none;
            outline: none;
            /* background: #fff; */
            /* background-color: rgba(197, 197, 197, 0.5); */
            background: #C7EDCC;
        }

        .article-title {
            border-radius: 0.5rem 0.5rem 0 0;
            font-size: 2rem;
            padding: .5rem;
        }

        .article-tags {
            border-radius: 0 0.5rem 0 0;
        }

        .select-item {
            width: 50%;
        }

        .article-summary {
            border-top: rgba(128, 128, 128, 0.5) solid 0.5px;
        }

        .article-content {
            width: 100%;
            overflow-y: hidden;
            padding: 1rem;
        }

        .article-select {
            border-top: rgba(128, 128, 128, 0.5) solid 0.5px;
            padding: .5rem;
        }

        .article-tools {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;

            border-top: rgba(128, 128, 128, 0.5) solid 0.5px;
            border-bottom: rgba(128, 128, 128, 0.5) solid 0.5px;

        }

        .article-tools a {
            padding: 0 .5rem;
        }

        .article-edit {
            font-family: Menlo, Monaco, Consolas, "Courier New", monospace;
            /* font-size: 13px; */
            border-right: rgba(128, 128, 128, 0.5) solid 0.5px;
        }

        .form-control {
            border: none;
        }


        /*svg字符串上传面板*/
        .fixed-card {
            position: fixed;
            width: 60rem;
            z-index: 99;
            display: none;
            height: 22rem;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <div th:insert="templates/user/header"></div>
    <div class=" container ">

        <div class="card fixed-card" id="fixed-card">
            <div class="card-header">
                <span id="svg-header">选择渲染js</span>
                <a href="javascript:;" onclick="saveSvg()">保存</a>
                <a href="javascript:;" onclick="saveSvg()">更新</a>
                <a href="javascript:;" id="closeBtn">&times;</a>
            </div>
            <div class="card-body row">
                <div class="col-sm">
                    <textarea data-render="" class="form-control border border-primary" id="componentInput"
                        rows="10"></textarea>
                </div>
                <div id="componentPreview" class="col-sm">
                    
                </div>
            </div>
        </div>


        <form>
            <div class="d-flex flex-column shadow-lg article-panel">
                <div class="d-flex">
                    <input th:value="${view?.title}" id="title" class="article-input article-title flex-fill"
                        type="text" placeholder="请输入文章标题">
                    <!-- <select class="article-select article-input flex-fill "> -->

                </div>
                <div class="d-flex align-items-center article-select">
                    <!-- <select id="categories" class="  flex-fill form-control form-control-chosen-required"
                        data-placeholder="Please select..."> -->
                    <div class="select-item mr-2">
                        <select id="categories" class=" form-control">
                            <option selected disabled hidden>请选择一个分类</option>
                            <!-- <option></option>
                                                    <option>1</option>
                                                    <option>2</option>
                                                    <option>3</option>
                                                    <option>4</option>
                                                    <option>5</option> -->
                        </select>
                    </div>
                    <div class="select-item">
                        <div id="my-tag-list" class=" tag-list  flex-fill"></div>
                    </div>


                </div>
                <div class="d-flex">
                    <textarea id="summary" class="article-input article-summary flex-fill "
                        placeholder="请输入摘要（不输入，将自动从文章截取）" rows="2" th:text="${view?.summary}"></textarea>
                </div>
                <div class="article-tools article-input d-flex justify-content-between">


                    <div>
                        <a href="javascript:;" id="openLatex">latex</a>
                        <a href="javascript:;" id="openMermaid">mermaid</a>
                        <a href="javascript:;" id="uploadFile">上传</a>
                        <a href="javascript:;" onclick="fullEdit()">编辑</a>
                        <a href="javascript:;" onclick="fullPreview()">预览</a>
                    </div>
                </div>
                <div class="d-flex">
                    <textarea class="article-input article-content flex-fill article-edit" placeholder="输入文章内容"
                        id="textInput" rows="20" th:text="${view?.originalContent}"></textarea>
                    <div id="preview" class="article-input article-content flex-fill markdown">

                    </div>
                    <!-- <textarea  ></textarea> -->
                    <!-- onpropertychange="this.style.height = this.scrollHeight + 'px';"
                        oninput="this.style.height = this.scrollHeight + 'px';" rows="20" -->
                </div>
            </div>

        </form>
        <div class="write-option">
            <button type="button" class="btn btn-success">附件</button>
            <button type="button" class="btn btn-danger" id="save">保存</button>
            <button type="button" class="btn btn-warning" id="previewNet">预览</button>
            <button type="button" class="btn btn-info" id="submitCreate">首次发布</button>
            <button type="button" class="btn btn-info" id="submitUpdate" style="display: none;">更新发布</button>

        </div>

        <div id="uploadPanel" class="uploadPanel" style="display: none;">
            <div class="p-2">
                <div>
                    <input type="file" name="file" id="file">
                </div>
                <div class="progress mt-2">
                    <div class="progress-bar" style="width: 0%;"></div>
                </div>
                <!-- <progress value="22" max="100">
                </progress> -->
            </div>
        </div>
        <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="mr-auto">消息</strong>
                <button id="closeToast" type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="toast-body" id="toast-body">
                Hello, world! This is a toast message.
            </div>
        </div>
    </div>

    <div th:insert="html/components/footer :: #footer" class="mt-3"></div>


    <script src="/templates/resources/js/jquery-3.4.1.min.js"></script>

    <script src="/templates/resources/js/jquery.cookie.js"></script>

    <script src="/templates/resources/js/markdown-it.min.js"></script>

    <script src='/templates/resources/js/bootstrap-tags.min.js'></script>
    <script src="/templates/resources/js/index.js"></script>
    <script src="/templates/resources/js/user.js"></script>
    <script src="/templates/resources/js/write.js"></script>
    <script src="/templates/resources/js/mermaid.min8.5.1.js"></script>
    <script>

        // moveClose("fixed-card-header", "fixed-card", "fixed-card-close");

        cmsWrite.defaultCategoryId = [[${ view?.categoryId }]]
        setSelectTags([[${ view?.tagIds }]])
        cmsWrite.articleId = null
        function setArticleId(param) {
            cmsWrite.articleId = param
        }
        setArticleId([[${ view?.id }]])
        /**
         * 判断是否在更新页面
         */
        if (cmsWrite.articleId) {
            $("#submitCreate").css("display", "none")
            $("#submitUpdate").css("display", "inline-block")
        }
        cmsWriteInit()
        formatHtml()





        function uploadStrContentChange(originalData, svgInput, attachmentId) {
            // let svgInput = $("#svgInput").val()
            // console.log(svgInput)
            // console.log(originalData)
            let dataRender = $("#componentInput").attr("data-render")
            let uploadUrl = protocol + "//" + url + ":8080/api/attachment/uploadStrContent"
            if (attachmentId) {
                uploadUrl += "/" + attachmentId
            }
            $.ajax({
                url: uploadUrl,
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                type: 'post',
                data: svgInput,
                dataType: 'json',
                contentType: "application/json;charset=UTF-8",
                success: function (data) {
                    // console.log(data.data)

                    formatHtml()
                    if (data.data.suffix == "svg") {
                        result = "<img data-render='" + dataRender + "' class='svg-components' data-attachment='" + data.data.id + "' alt='" + originalData + "' src='" + data.data.path + "'>"
                        $("#textInput").insertAtCaret(result)
                    }
                }
            });
        }





        mermaid.mermaidAPI.initialize({
            startOnLoad: false
        });

        function renderMermaid(componentInput, componentPreview) {
            var needsUniqueId = "render" + (Math.floor(Math.random() * 10000)).toString(); //should be 10K attempts before repeat user finger stops working before then hopefully
            function mermaidApiRenderCallback(graph) {
                // $('#mermaidPreview').html(graph);
                componentPreview.html(graph)
            }
            try {
                mermaid.mermaidAPI.render(needsUniqueId, componentInput, mermaidApiRenderCallback);

            } catch (e) {
                componentPreview.html(componentPreview.html() + e)
            }
        }

        function renderLatex(componentInput, componentPreview) {

            $.ajax({
                url: protocol + "//" + url + ":8080/api/latex/svg",
                headers: {

                    'Authorization': 'Bearer ' + token
                },
                type: 'post',
                // dataType: 'xml',
                contentType: "application/json;charset=UTF-8",
                data: JSON.stringify({ "latex": componentInput }),
                success: function (data) {

                    componentPreview.html(data)

                }
            });

        }


        // 原始svg监听
        $("#componentInput").bind('input propertychange', function () {
            let componentPreview = $("#componentPreview")
            let componentInput = $("#componentInput").val()
            let dataRender = $("#componentInput").attr("data-render")

            if (dataRender == "mermaid") {
                renderMermaid(componentInput, componentPreview)
            } else if (dataRender == "latex") {
                renderLatex(componentInput, componentPreview)
            }

        });


        // 上传svg字符串
        let svgAttachmentId = null
        function saveSvg() {
            uploadStrContentChange($("#componentInput").val(), $("#componentPreview").html(), svgAttachmentId)
            $("#fixed-card").css("display", "none")
            formatHtml()
            svgAttachmentId = null
        }

        // 修改Svg
        $(document).on('click', '.svg-components', function () {
            let componentPreview = $("#componentPreview")
            var val = $(this).attr("data-attachment");
            let dataRender = $("#componentInput").attr("data-render")
            let altContent = $(this).attr("alt")
            // console.log(val)
            svgAttachmentId = val
            $("#componentInput").val(altContent)
            $("#fixed-card").css("display", "block")
            if (dataRender == "mermaid") {
                renderMermaid(altContent, componentPreview)
                $("#componentInput").attr("data-render", "mermaid")
                $("#svg-header").html("修改mermaid")
            } else if (dataRender == "latex") {

                $("#componentInput").attr("data-render", "latex")
                $("#svg-header").html("修改Latex")
                
                renderLatex(altContent, componentPreview)
            }
            
        });


        // 打开 mermaid窗口
        $("#openMermaid").click(function () {
            // debugger
            $("#componentInput").attr("data-render", "mermaid")
            $("#svg-header").html("插入Mermaid")
            $("#fixed-card").css("display", "block")
        })

        $("#openLatex").click(function () {
            $("#componentInput").attr("data-render", "latex")
            $("#svg-header").html("插入Latex")
            $("#fixed-card").css("display", "block")
        })

        $("#closeBtn").click(function () {
            $("#fixed-card").css("display", "none")
        })


        // $("#componentInput").bind('input propertychange', function () {

        // })
    </script>
    <script>
        // http://localhost:8080/user/latex/svg
        // http://localhost:8080/api/latex/svgSave


    </script>
</body>

</html>